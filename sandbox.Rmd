---
title: "final_proj"
output: html_document
---

# Setup
```{r setup}
library(xlsx)
library(tidyverse)
library(stringr)
library(plyr)
library(dplyr)
library(readr)
STATES <- c("Alabama", "Alaska", "Arizona", "Arkansas", "California", "Colorado", "Connecticut", "Delaware", "Florida", "Georgia", "Hawaii", "Idaho", "Illinois", "Indiana", "Iowa", "Kansas", "Kentucky", "Louisiana", "Maine", "Maryland", "Massachusetts", "Michigan", "Minnesota", "Mississippi", "Missouri", "Montana", "Nebraska", "Nevada", "New Hampshire", "New Jersey", "New Mexico", "New York", "North Carolina", "North Dakota", "Ohio", "Oklahoma", "Oregon", "Pennsylvania", "Rhode Island", "South Carolina", "South Dakota", "Tennessee", "Texas", "Utah", "Vermont", "Virginia", "Washington", "West Virginia", "Wisconsin", "Wyoming")
```

# Data gathering
Ex: In terminal, download data via
> wget https://www.justice.gov/crt/about/vot/notices/vnote022712.xls

Picking data URL
```{r}
dates <- seq(as.Date("2010-09-27"), as.Date("2012-07-30"), by = 1)
urls <- paste("https://www.justice.gov/crt/about/vot/notices/vnote",
              str_sub(dates, 6, 7),
              str_sub(dates, 9, 10),
              str_sub(dates, 3, 4),
              ".xls", sep = "")
```

Downloading the data
```{r, eval = FALSE}
oldw <- getOption("warn")
options(warn = -1)
for (url in urls) {
    tryCatch(download.file(url,
                           paste("./data/", str_sub(url, 47), sep = ""),
                           quiet = FALSE),
             error = function(e) print("")) #consider tracking the successful urls   
}
options(warn = oldw)
```

# Data preprocessing

Tidying the data
```{r}
read_and_tidy <- function(fileName) {
  file_messy <- read.xlsx(fileName, sheetName = "Sheet1")
  file <- file_messy %>%
    select(1, 4, 7, 11, 15, 18, 21, 25) %>%
    unite(NA..23, NA..23, NA..19) %>%
    dplyr::rename(state = NA.,
                  county = NA..3,
                  subjurisdiction = NA..5,
                  submission = NA..9,
                  action_date = NA..13,
                  action = NA..16,
                  changes = NA..23) %>%
    filter(state %in% STATES) %>%
    mutate(action_date = as.Date(action_date, "%m/%d/%Y"),
           changes = str_replace(changes, "_NA", ""),
           changes = str_replace(changes, "NA_", ""))
  
  # Replace NA values in certain county & subjurisdiction fields, which threw errors when working through Ubuntu
  levels <- levels(file$county)
  levels[length(levels) + 1] <- "None"
  file$county <- factor(file$county, levels = levels)
  file$county[is.na(file$county)] <- "None"
  levels <- levels(file$subjurisdiction)
  levels[length(levels) + 1] <- "None"
  file$subjurisdiction <- factor(file$subjurisdiction, levels = levels)
  file$subjurisdiction[is.na(file$subjurisdiction)] <- "None"
  return(file)
}
```

Aggregating the data
```{r}
myfiles <- list.files(path = "./data", pattern = "*.xls", full.names = TRUE)
data <- ldply(myfiles, read_and_tidy)
```